# Prove v0.7 — IO Extensions and Parse

## Goal

Extend InputOutput with the channels the self-hosted compiler needs
(process execution, directory operations, command-line arguments) and
add the Parse module for reading `prove.toml`.

**Prerequisite:** v0.6 (core stdlib) must be complete.

---

## Modules

### 1. `InputOutput` (Extended) — Process Execution and Process State

The existing `InputOutput` module (`console`, `file`) gains `system`,
`dir`, and `process` channels plus `validates` for existence checks.

```prove
module InputOutput
  narrative: "Handles IO operations."

  type ExitCode is Integer where 0 .. 255

  type ProcessResult is
    exit_code ExitCode
    standard_output String
    standard_error String

  type DirEntry is
      File(name String, path String)
    | Directory(name String, path String)
```

| Channel | Verb | Signature | C backing | Python equivalent |
|---------|------|-----------|-----------|-------------------|
| `console` | `inputs` | `console() String` | `fgets(stdin)` | `input()` |
| `console` | `outputs` | `console(text String)` | `fputs(stdout)` | `print()` |
| `console` | `validates` | `console() Boolean` | `!feof(stdin)` | `not sys.stdin.closed` |
| `file` | `inputs` | `file(path String) String!` | `fopen`+`fread` | `open(p).read()` |
| `file` | `outputs` | `file(path String, content String)!` | `fopen`+`fwrite` | `open(p,'w').write()` |
| `file` | `validates` | `file(path String) Boolean` | `access()` | `os.path.isfile()` |
| `system` | `inputs` | `system(command String, args List<String>) ProcessResult!` | `fork+exec+waitpid` | `subprocess.run()` |
| `system` | `outputs` | `system(code ExitCode)` | `exit()` | `sys.exit()` |
| `system` | `validates` | `system(command String) Boolean` | Search `PATH` | `shutil.which()` |
| `dir` | `inputs` | `dir(path String) List<DirEntry>!` | `opendir`+`readdir` | `os.listdir()` |
| `dir` | `outputs` | `dir(path String)!` | `mkdir()` | `os.mkdir()` |
| `dir` | `validates` | `dir(path String) Boolean` | `stat()` | `os.path.isdir()` |
| `process` | `inputs` | `process() List<String>` | `argc`/`argv` | `sys.argv` |
| `process` | `validates` | `process(value String) Boolean` | `argv` contains value | `x in sys.argv` |

**C file:** Extend existing `prove_input_output.c` (~150 lines added)

---

### 2. `Parse` — Format Codecs

Needed for: reading `prove.toml` configuration. Extensible to any
structured format (JSON, YAML, etc.) with the same two-function pattern.

```prove
module Parse
  narrative: "Encoding and decoding of structured data formats."
```

| Function | Signature | C backing |
|----------|-----------|-----------|
| `toml` | `creates toml(source String) Result<T, String>` | TOML parser, maps to target type |
| `toml` | `reads toml(value T) String` | Struct to TOML text |
| `json` | `creates json(source String) Result<T, String>` | JSON parser, maps to target type |
| `json` | `reads json(value T) String` | Struct to JSON text |

**C files:** `prove_parse_toml.c` (~300 lines), `prove_parse_json.c` (~250 lines)
— each format is a separate C file, all registered under the `Parse` module.

Additional formats (YAML, CSV, etc.) follow the same pattern: add a
function named after the format with `:creates` and `:reads` verbs.

---

### 3. C FFI — Foreign Function Interface

The self-hosted compiler needs to call C libraries directly. The FFI
allows declaring external C functions and wrapping them with Prove's
verb system.

```prove
foreign "libc"
  c_malloc(size Integer) Integer    // void* as Integer (opaque pointer)
  c_free(ptr Integer)
  c_strlen(s String) Integer
  c_getenv(name String) Integer     // char* as Integer (nullable)

foreign "libm"
  c_sin(x Float) Float
  c_cos(x Float) Float
  c_sqrt(x Float) Float
```

Foreign declarations are raw C bindings — no verb, no contracts.
They are **not callable directly from Prove code**. Instead, they
must be wrapped in a Prove function with a verb:

```prove
module Math
  narrative: "Mathematical functions."

  foreign "libm"
    c_sin(x Float) Float
    c_sqrt(x Float) Float

  transforms sin(x Float) Float
  from
    c_sin(x)

  transforms sqrt(x Float) Float
    requires x >= 0.0
    ensures result >= 0.0
  from
    c_sqrt(x)
```

**Rules:**
- `foreign` blocks declare external C functions (name mangling: none)
- Foreign functions are module-private — not exported
- Prove wrappers provide verbs, contracts, and type safety
- The compiler emits `#include` and linker flags from the `foreign` block
- Library names map to `-l` flags: `"libm"` → `-lm`

**C emission:**
```c
#include <math.h>    // from foreign "libm"

double prove_Math_transforms_sin(double x) {
    return sin(x);   // direct call to foreign function
}
```

**`prove.toml` configuration:**
```toml
[build]
c_flags = ["-I/usr/local/include"]
link_flags = ["-L/usr/local/lib"]
```

**C file:** No new runtime file — foreign declarations generate inline
C calls. The compiler handles `#include` generation and linker flags.

---

## Summary

| Component | Functions | C lines (est.) | Purpose |
|-----------|-----------|----------------|---------|
| `InputOutput` (ext) | +14 | +150 | system, dir, process, validates |
| `Parse` | 4 | 550 | Format codecs (TOML, JSON) |
| C FFI | — | 0 | Foreign function declarations (compiler support) |
| **Total** | **18** | **~700** | |

---

## Deliverables

| Deliverable | Description |
|-------------|-------------|
| `prove_input_output.c/h` | Extend existing InputOutput runtime |
| `prove_parse_toml.c/h` | TOML codec for Parse module |
| `prove_parse_json.c/h` | JSON codec for Parse module |
| `stdlib/input_output.prv` | Extended InputOutput type signatures |
| `stdlib/parse.prv` | Parse module signatures |
| `c_runtime.py` | Register new runtime files |
| `stdlib_loader.py` | Register new stdlib modules |
| Tests | Unit tests for each C implementation |

---

## Verification

Write small `.prv` programs using each module, compile and run them
with the Python compiler. Each program exercises the module's full API.
