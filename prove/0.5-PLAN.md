# Prove v0.5 — Turbo Runtime

## Goal

Portable C runtime primitives for the performance-critical paths:
arena allocation, fast hashing, and string interning. These are the
foundation that Table, the intern table, and the self-hosted compiler
build on.

No assembly — pure portable C with a small `#ifdef` for the hash
function's hardware CRC32 (x86_64 + ARM64 + fallback).

**Prerequisite:** v0.4 (language features) must be complete.

---

## Components

### 1. Arena Allocator

Bump-pointer allocator for compile-time lifetimes. The compiler
creates thousands of AST nodes, tokens, and intermediate strings
that all live for the duration of a compilation pass, then get
freed at once. Eliminates per-object `malloc`/`free` and removes
the need for reference counting on arena-allocated objects.

```c
// API
Prove_Arena *prove_arena_new(size_t initial_capacity);
void        *prove_arena_alloc(Prove_Arena *a, size_t size, size_t align);
void         prove_arena_reset(Prove_Arena *a);   // reuse memory
void         prove_arena_free(Prove_Arena *a);     // release everything
```

**C file:** `prove_arena.c/h` (~80 lines)

---

### 2. Fast Hash

Hardware-accelerated CRC32 string hash. Both x86_64 and ARM64 have
CRC32 instructions; a portable fallback covers everything else.
Used internally by Table and the string intern table.

```c
// API
uint32_t prove_hash(const char *data, size_t len);
```

```c
#if defined(__x86_64__) && defined(__SSE4_2__)
  #include <nmmintrin.h>
  // _mm_crc32_u8 loop
#elif defined(__aarch64__)
  #include <arm_acle.h>
  // __crc32cb loop
#else
  // FNV-1a fallback
#endif
```

**C file:** `prove_hash.c/h` (~50 lines)

---

### 3. String Intern Table

Deduplicates strings so that repeated identifiers (variable names,
keywords, type names) are stored once. After interning, all string
comparisons become pointer equality — one instruction instead of
a `strcmp` loop. Uses the arena for storage and the fast hash for
lookup.

```c
// API
Prove_Intern *prove_intern_new(Prove_Arena *a);
const char   *prove_intern(Prove_Intern *t, const char *s, size_t len);
bool          prove_intern_eq(const char *a, const char *b);  // ptr ==
```

**C file:** `prove_intern.c/h` (~120 lines)

---

## Summary

| Component | Functions | C lines (est.) |
|-----------|-----------|----------------|
| Arena allocator | 4 | 80 |
| Fast hash | 1 | 50 |
| String intern table | 3 | 120 |
| **Total** | **8** | **~250** |

---

## Deliverables

| Deliverable | Description |
|-------------|-------------|
| `prove_arena.c/h` | Bump-pointer arena allocator |
| `prove_hash.c/h` | Hardware CRC32 hash (x86_64 + ARM64 + fallback) |
| `prove_intern.c/h` | String intern table |
| `c_runtime.py` | Register new runtime files |
| Tests | Unit tests for each component |

---

## Verification

- Arena: allocate many objects, verify alignment, reset, reallocate
- Hash: compare output across platforms (deterministic), benchmark vs naive hash
- Intern: intern same string twice → same pointer, different strings → different pointers
- All tests pass on both x86_64 and ARM64
