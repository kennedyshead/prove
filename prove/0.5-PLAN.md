# Prove v0.5 — Compiler Stdlib

## Goal

Implement the stdlib modules the self-hosted compiler needs. Each is a
`.prv` file declaring types and function signatures, backed by a C
implementation that the Python compiler links in.

**Prerequisite:** v0.3 (legacy stdlib cleanup) and v0.4 (language
features) must be complete.

---

## Modules

### 1. `InputOutput` (Extended) — Process Execution and Process State

The existing `InputOutput` module (`console`, `file`) gains `system`,
`dir`, and `process` channels plus `validates` for existence checks.

```prove
module InputOutput
  narrative: "Handles IO operations."

  type ExitCode is Integer where 0 .. 255

  type ProcessResult is
    exit_code ExitCode
    standard_output String
    standard_error String

  type DirEntry is
      File(name String, path String)
    | Directory(name String, path String)
```

| Channel | Verb | Signature | C backing | Python equivalent |
|---------|------|-----------|-----------|-------------------|
| `console` | `inputs` | `console() String` | `fgets(stdin)` | `input()` |
| `console` | `outputs` | `console(text String)` | `fputs(stdout)` | `print()` |
| `console` | `validates` | `console() Boolean` | `!feof(stdin)` | `not sys.stdin.closed` |
| `file` | `inputs` | `file(path String) String!` | `fopen`+`fread` | `open(p).read()` |
| `file` | `outputs` | `file(path String, content String)!` | `fopen`+`fwrite` | `open(p,'w').write()` |
| `file` | `validates` | `file(path String) Boolean` | `access()` | `os.path.isfile()` |
| `system` | `inputs` | `system(command String, args List<String>) ProcessResult!` | `fork+exec+waitpid` | `subprocess.run()` |
| `system` | `outputs` | `system(code ExitCode)` | `exit()` | `sys.exit()` |
| `system` | `validates` | `system(command String) Boolean` | Search `PATH` | `shutil.which()` |
| `dir` | `inputs` | `dir(path String) List<DirEntry>!` | `opendir`+`readdir` | `os.listdir()` |
| `dir` | `outputs` | `dir(path String)!` | `mkdir()` | `os.mkdir()` |
| `dir` | `validates` | `dir(path String) Boolean` | `stat()` | `os.path.isdir()` |
| `process` | `inputs` | `process() List<String>` | `argc`/`argv` | `sys.argv` |
| `process` | `validates` | `process(value String) Boolean` | `argv` contains value | `x in sys.argv` |

**C file:** Extend existing `prove_input_output.c` (~150 lines added)

---

### 2. `Table` — Hash Map

Needed for: symbol tables, keyword lookup, type registries, seen-sets,
builtin dispatch tables. The Python compiler uses `dict` everywhere.

```prove
module Table
  narrative: "Hash table from String keys to values."

  type Table<V> is binary
```

| Function | Signature | C backing |
|----------|-----------|-----------|
| `new` | `creates new() Table<V>` | Allocate hash table |
| `has` | `validates has(key String, table Table<V>) Boolean` | Key exists check |
| `add` | `saves add(key String, value V, table Table<V>) Table<V>` | Insert/update |
| `get` | `reads get(key String, table Table<V>) Option<V>` | Lookup |
| `remove` | `saves remove(key String, table Table<V>) Table<V>` | Delete key |
| `keys` | `reads keys(table Table<V>) List<String>` | All keys |
| `values` | `reads values(table Table<V>) List<V>` | All values |
| `length` | `reads length(table Table<V>) Integer` | Entry count |

**C file:** `prove_table.c` (~250 lines) — open-addressing hash table with
`prove_string_hash()` and `prove_string_eq()` for keys.

---

### 3. `Character` — Character and String Operations

Needed for: lexer (classifying characters, building tokens), string
manipulation throughout the compiler.

```prove
module Character
  narrative: "Character classification and string building."

  type StringBuilder is binary
```

| Function | Signature | C backing |
|----------|-----------|-----------|
| `alpha` | `validates alpha(c Character) Boolean` | `isalpha()` |
| `digit` | `validates digit(c Character) Boolean` | `isdigit()` |
| `alnum` | `validates alnum(c Character) Boolean` | `isalnum()` |
| `upper` | `validates upper(c Character) Boolean` | `isupper()` |
| `lower` | `validates lower(c Character) Boolean` | `islower()` |
| `space` | `validates space(c Character) Boolean` | `isspace()` |
| `at` | `transforms at(s String, i Integer) Character` | Index into string |
| `slice` | `transforms slice(s String, start Integer, end Integer) String` | Slice |
| `starts_with` | `validates starts_with(s String, prefix String) Boolean` | `strncmp` |
| `ends_with` | `validates ends_with(s String, suffix String) Boolean` | Compare tail |
| `contains` | `validates contains(s String, sub String) Boolean` | `strstr` |
| `index_of` | `transforms index_of(s String, sub String) Option<Integer>` | `strstr` offset |
| `split` | `transforms split(s String, sep String) List<String>` | Split by separator |
| `join` | `transforms join(parts List<String>, sep String) String` | Join with separator |
| `trim` | `transforms trim(s String) String` | Strip whitespace |
| `lower` | `transforms to_lower(s String) String` | Lowercase copy |
| `upper` | `transforms to_upper(s String) String` | Uppercase copy |
| `replace` | `transforms replace(s String, old String, new String) String` | Replace all occurrences |
| `builder` | `creates builder() StringBuilder` | Allocate growable buffer |
| `write` | `saves write(sb StringBuilder, s String) StringBuilder` | Append string |
| `write_char` | `saves write_char(sb StringBuilder, c Character) StringBuilder` | Append char |
| `build` | `reads build(sb StringBuilder) String` | Finalize to String |
| `builder_length` | `reads builder_length(sb StringBuilder) Integer` | Current length |
| `repeat` | `transforms repeat(s String, n Integer) String` | Repeat n times |

**C file:** `prove_character.c` (~200 lines)

---

### 4. `Parse` — Format Codecs

Needed for: reading `prove.toml` configuration. Extensible to any
structured format (JSON, YAML, etc.) with the same two-function pattern.

```prove
module Parse
  narrative: "Encoding and decoding of structured data formats."
```

| Function | Signature | C backing |
|----------|-----------|-----------|
| `toml` | `creates toml(source String) Result<T, String>` | TOML parser, maps to target type |
| `toml` | `reads toml(value T) String` | Struct to TOML text |
| `json` | `creates json(source String) Result<T, String>` | JSON parser, maps to target type |
| `json` | `reads json(value T) String` | Struct to JSON text |

**C files:** `prove_parse_toml.c` (~300 lines), `prove_parse_json.c` (~250 lines)
— each format is a separate C file, all registered under the `Parse` module.

Additional formats (YAML, CSV, etc.) follow the same pattern: add a
function named after the format with `:creates` and `:reads` verbs.

---

## Summary

| Module | Functions | C lines (est.) | Purpose |
|--------|-----------|----------------|---------|
| `InputOutput` (ext) | +14 | +150 | system, dir, process, validates |
| `Table` | 8 | 250 | Hash map |
| `Character` | 23 | 200 | Character/string ops |
| `Parse` | 4 | 550 | Format codecs (TOML, JSON) |
| **Total** | **49** | **~1,150** | |

---

## Deliverables

| Deliverable | Description |
|-------------|-------------|
| `prove_input_output.c/h` | Extend existing InputOutput runtime |
| `prove_table.c/h` | C runtime for Table module |
| `prove_character.c/h` | C runtime for Character module |
| `prove_parse_toml.c/h` | TOML codec for Parse module |
| `prove_parse_json.c/h` | JSON codec for Parse module |
| `stdlib/input_output.prv` | Extended InputOutput type signatures |
| `stdlib/table.prv` | Prove type signatures |
| `stdlib/character.prv` | Prove type signatures |
| `stdlib/parse.prv` | Parse module signatures |
| `c_runtime.py` | Register new runtime files |
| `stdlib_loader.py` | Register new stdlib modules |
| Tests | Unit tests for each C implementation |

---

## Verification

Write small `.prv` programs using each module, compile and run them
with the Python compiler. Each program exercises the module's full API.

Language features required by this stdlib are delivered in v0.4
(see `0.4-PLAN.md`).
